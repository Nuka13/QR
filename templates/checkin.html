<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisutnost</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 90%; margin: 40px auto; padding: 20px; }
        h2 { text-align: center; }
        input, button { padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; font-size: 16px; }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; }
        #response { margin-top: 20px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Prisutnost</h2>

    <form id="checkin-form">
        <input type="hidden" name="token" id="token" value="{{ token }}">

        <label>Ime:</label>
        <input type="text" name="ime" required placeholder="Vaše ime">

        <label>JMBAG:</label>
        <input type="text" name="jmbag" required placeholder="00365...">

        <input type="hidden" name="device_id" id="device_id">

        <button type="submit">Prijavi se</button>
    </form>

    <p id="response"></p>

    <script>
    // Persistent device ID
    let deviceId = localStorage.getItem("attendance_device_id");
    if (!deviceId) {
        deviceId = crypto.randomUUID ? crypto.randomUUID() : "dev-" + Date.now() + Math.random().toString(36).substr(2);
        localStorage.setItem("attendance_device_id", deviceId);
    }
    document.getElementById("device_id").value = deviceId;

    const form = document.getElementById("checkin-form");
    const responseEl = document.getElementById("response");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        responseEl.style.color = "black";
        responseEl.textContent = "Šaljem...";

        const data = {
            ime: form.querySelector("[name='ime']").value.trim(),
            jmbag: form.querySelector("[name='jmbag']").value.trim(),
            device_id: deviceId,
            token: form.querySelector("[name='token']").value.trim()
        };

        try {
            const res = await fetch("/checkin", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            let result;
            try {
                result = await res.json();
            } catch {
                // Server sent HTML or invalid JSON → fallback
                result = { detail: "Server error - invalid response" };
            }

            if (res.ok) {
                responseEl.style.color = "green";
                responseEl.textContent = "Uspješno prijavljeno!";
                form.reset();
            } else {
                responseEl.style.color = "red";
                responseEl.textContent = result.detail || "Greška pri prijavi";
            }
        } catch (err) {
            responseEl.style.color = "red";
            responseEl.textContent = "Nema veze sa serverom: " + err.message;
        }
    });
</script>
</body>
</html>