<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <title>Prisutnost</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --surface: #13131a;
            --border: #1e1e2e;
            --accent: #00e5a0;
            --accent-dim: rgba(0,229,160,0.12);
            --warn: #ff6b35;
            --warn-dim: rgba(255,107,53,0.12);
            --text: #e8e8f0;
            --muted: #555570;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Syne', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 24px;
            overflow: hidden;
        }

        /* subtle grid bg */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(0,229,160,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,229,160,0.03) 1px, transparent 1px);
            background-size: 48px 48px;
            pointer-events: none;
        }

        /* top bar */
        .topbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: rgba(10,10,15,0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .topbar-title {
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }
        .logout {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--muted);
            text-decoration: none;
            border: 1px solid var(--border);
            padding: 6px 14px;
            border-radius: 4px;
            letter-spacing: 0.05em;
            transition: color 0.2s, border-color 0.2s;
        }
        .logout:hover { color: var(--warn); border-color: var(--warn); }

        /* main layout */
        .main {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 28px;
            margin-top: 16px;
        }

        /* QR frame */
        .qr-frame {
            position: relative;
            padding: 18px;
            background: white;
            border-radius: 12px;
            box-shadow:
                0 0 0 1px var(--border),
                0 0 60px rgba(0,229,160,0.08),
                0 24px 64px rgba(0,0,0,0.5);
        }
        .qr-frame img {
            display: block;
            width: 420px;
            height: 420px;
            transition: opacity 0.25s;
            border-radius: 4px;
        }
        .qr-frame img.refreshing { opacity: 0.15; }

        /* corner accents */
        .qr-frame::before, .qr-frame::after,
        .corner-bl, .corner-br {
            content: '';
            position: absolute;
            width: 20px; height: 20px;
            border-color: var(--accent);
            border-style: solid;
        }
        .qr-frame::before { top: -1px; left: -1px; border-width: 3px 0 0 3px; border-radius: 3px 0 0 0; }
        .qr-frame::after  { top: -1px; right: -1px; border-width: 3px 3px 0 0; border-radius: 0 3px 0 0; }
        .corner-bl { bottom: -1px; left: -1px; border-width: 0 0 3px 3px; border-radius: 0 0 0 3px; }
        .corner-br { bottom: -1px; right: -1px; border-width: 0 3px 3px 0; border-radius: 0 0 3px 0; }

        /* countdown ring */
        .countdown-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .countdown-ring {
            position: relative;
            width: 72px;
            height: 72px;
        }
        .countdown-ring svg { transform: rotate(-90deg); }
        .ring-bg   { stroke: var(--border); }
        .ring-prog { stroke: var(--accent); stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.4s; }
        .ring-label {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }
        .status-pill {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--accent-dim);
            color: var(--accent);
            border: 1px solid rgba(0,229,160,0.25);
            transition: all 0.3s;
        }
        .status-pill.warn {
            background: var(--warn-dim);
            color: var(--warn);
            border-color: rgba(255,107,53,0.25);
        }

        /* stats row */
        .stats-row {
            display: flex;
            gap: 16px;
        }
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 32px;
            min-width: 140px;
        }
        .stat-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--muted);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
        }
        .stat-value.plain { color: var(--text); font-size: 1.5rem; }

        /* actions */
        .actions {
            display: flex;
            gap: 12px;
        }
        button {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            letter-spacing: 0.08em;
            padding: 11px 22px;
            border: 1px solid;
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
            transition: background 0.2s, color 0.2s, transform 0.1s;
        }
        button:active { transform: scale(0.97); }
        .btn-refresh { color: var(--accent); border-color: rgba(0,229,160,0.4); }
        .btn-refresh:hover { background: var(--accent-dim); }
        .btn-reset   { color: var(--warn);   border-color: rgba(255,107,53,0.4); }
        .btn-reset:hover   { background: var(--warn-dim); }

        /* toast */
        #toast {
            position: fixed;
            bottom: 28px; left: 50%;
            transform: translateX(-50%) translateY(60px);
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 11px 22px;
            border-radius: 6px;
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>

<div class="topbar">
    <span class="topbar-title">// prisutnost.sustav</span>
    <a href="/logout" class="logout">odjava</a>
</div>

<div class="main">

    <div class="qr-frame">
        <div class="corner-bl"></div>
        <div class="corner-br"></div>
        <img id="qr-image" src="/qr" alt="QR kod">
    </div>

    <div class="countdown-wrap">
        <div class="countdown-ring">
            <svg width="72" height="72" viewBox="0 0 72 72">
                <circle class="ring-bg"   cx="36" cy="36" r="30" fill="none" stroke-width="5"/>
                <circle class="ring-prog" id="ring" cx="36" cy="36" r="30" fill="none" stroke-width="5"
                    stroke-dasharray="188.5" stroke-dashoffset="0"/>
            </svg>
            <div class="ring-label"><span id="seconds">{{ seconds_left }}</span>s</div>
        </div>
        <span id="status-pill" class="status-pill">● aktivan</span>
    </div>

    <div class="stats-row">
        <div class="stat">
            <span class="stat-label">prijavljenih</span>
            <span class="stat-value" id="count">{{ device_count }}</span>
        </div>
        <div class="stat">
            <span class="stat-label">interval</span>
            <span class="stat-value plain">{{ qr_refresh }}s</span>
        </div>
    </div>

    <div class="actions">
        <button class="btn-refresh" onclick="forceRefresh()">↻ osvježi qr</button>
        <button class="btn-reset"   onclick="resetSession()">✕ resetiraj sesiju</button>
    </div>

</div>

<div id="toast"></div>

<script>
    const TOTAL = Number("{{ qr_refresh }}");
    let timeLeft = Number("{{ seconds_left }}");
    const C = 188.5;
    const ring  = document.getElementById("ring");
    const pill  = document.getElementById("status-pill");
    const secEl = document.getElementById("seconds");

    function updateRing(t) {
        ring.style.strokeDashoffset = C * (1 - t / TOTAL);
        const warn = t / TOTAL < 0.35;
        ring.style.stroke = warn ? "var(--warn)" : "var(--accent)";
        pill.className = "status-pill" + (warn ? " warn" : "");
        pill.textContent = warn ? "● osvježavanje..." : "● aktivan";
    }

    function refreshQR() {
        const img = document.getElementById("qr-image");
        img.classList.add("refreshing");
        const tmp = new Image();
        tmp.onload = () => { img.src = tmp.src; img.classList.remove("refreshing"); };
        tmp.src = "/qr?t=" + Date.now();
    }

    function forceRefresh() {
        timeLeft = TOTAL;
        refreshQR();
        showToast("qr osvježen");
    }

    setInterval(() => {
        if (timeLeft <= 0) { refreshQR(); timeLeft = TOTAL; }
        updateRing(timeLeft);
        secEl.textContent = timeLeft;
        timeLeft--;
    }, 1000);
    updateRing(timeLeft);

    // live count
    setInterval(async () => {
        try {
            const r = await fetch("/admin/status");
            if (r.ok) document.getElementById("count").textContent = (await r.json()).device_count;
        } catch {}
    }, 5000);

    async function resetSession() {
        if (!confirm("Resetirati sesiju?")) return;
        const r = await fetch("/admin/reset", { method: "POST" });
        if (r.ok) { document.getElementById("count").textContent = "0"; showToast("sesija resetirana"); }
        else showToast("greška pri resetu");
    }

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 3000);
    }
</script>
</body>
</html>
